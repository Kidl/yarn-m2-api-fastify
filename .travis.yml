services:
- docker
language: node_js
node_js:
- "10"
env:
  global:
  - REPO=${TRAVIS_REPO_SLUG,,}
  - IMAGE=$REPO:${TRAVIS_COMMIT:0:8}
  - CONTAINER_NAME=yarn-m2-products-api
branches:
  - dev
  - stage
  - prod
cache:
  directories:
  - node_modules
before_install:
-  openssl aes-256-cbc -K $encrypted_c36e9544e5da_key -iv $encrypted_c36e9544e5da_iv -in secrets.tar.enc -out secrets.tar -d
- tar xvf secrets.tar
- curl -sSL https://sdk.cloud.google.com | CLOUDSDK_CORE_DISABLE_PROMPTS=1 bash >/dev/null
- export PATH=/home/travis/google-cloud-sdk/bin:$PATH
install:
- echo "//registry.npmjs.org/:_authToken=\${NPM_TOKEN}" > .npmrc
- npm install -g npm@latest
- npm install
- npm audit fix
- gcloud components install kubectl --quiet
- chmod +x ./*.sh
script: true
before_deploy: true
deploy:
  provider: script
  skip_cleanup: true
  script: "./deploy.sh"
  on:
    branch:
    - dev
    - stage
    - prod
